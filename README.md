# Calico-DSCP-Controller
A kubernetes controller that support traffic prioritization with DSCP marking.
Support Calico or other iptables based CNI.

## Prerequisites

Before you try out this controller, you need to prepare:
- A kubernetes cluster with calico installed
- Nodes are connected by a network switch that supports DSCP marking
- The network switch need to be configured about DSCP marking rule , for example:
  - dscp-to-tc mapping
  - tc-to-queue mapping
  - scheduler strategy
  And bind the DSCP marking rule to the network interface, configuration might vary from different network switch vendors.

## How to install

1. Install the controller

```
kubectl apply -f https://raw.githubusercontent.com/owenowenisme/calico-dscp-controller/refs/heads/main/dscp-deployment.yaml
```

2. Deploy the configmap 
```
kubectl apply -f https://raw.githubusercontent.com/owenowenisme/calico-dscp-controller/refs/heads/main/configmap.yaml
```
You can modified the dscp priority of namespace by changing the value in configmap.

## System Architecture
This project implemented a Kubernetes controller that, when deployed, creates a DaemonSet within the cluster. This DaemonSet is responsible for ensuring that our DSCP pods are always running on all nodes, and automatically restores them when these pods disappear due to certain factors.

Through these pods, we can control the iptables rules on each node, enabling packets generated by pods in our target applications to be tagged with DSCP labels before being sent out from the node.
![System Architecture](https://github.com/user-attachments/assets/a46c1f5e-1c5c-4d1c-a58e-00409c16df22)

When network switches receive packets with DSCP labels, they determine which queue to place them in based on the priority values pre-configured on the switch. The queue with the highest priority will be sent out first, while packets with lower priority are more likely to be dropped.

Through custom prioritization, we gain greater flexibility in deciding which applications are most important when running in highly congested clusters. This can significantly improve the efficiency of specified applications in distributed systems, such as distributed machine learning.


![SysSwitch Queue Mapping](https://github.com/user-attachments/assets/03b241eb-bf47-459f-9370-8fc2b3acf144)

## Result 

We tested the controller with a popular distributed machine learning framework, Ray to train a MNIST model.

To simulate the network congestion, we used iperf3 to generate traffic to the Ray cluster sending 1Gb of data per second from the client to the server in the cluster.

![dscp_training_performance_comparison](https://github.com/user-attachments/assets/69113682-a906-4c4a-b35c-e57f7808bebb)

With DSCP marking enabled, the training speed improved by approximately 9.1x compared to without DSCP marking, achieving performance nearly equivalent to an uncongested network environment.

With our controller, we can prioritize the traffic of the application, and the application can achieve better performance.
